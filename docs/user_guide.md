**SCMI Compliance Suite User Guide**
==============================

Table of Contents:

- [Introduction](#introduction)
- [Prerequisites](#prerequisites)
  * [Host machine requirements and tools](#host-machine-requirements-and-tools)
- [Getting SCMI test suite source code](#getting-scmi-test-suite-source-code)
- [Complaince suite design and library of tests](#test-suite-design-and-library-of-tests)
- [Build steps](#build-steps)
  * [1. Build the test suite as a library](#build-the-test-suite-as-a-library)
  * [2. Build the test suite as a test agent](#build-the-test-suite-as-a-test-agent)
- [Test suite execution](#test-suite-execution)
  * [Running the test agent on host machine](#running-the-test-agent-on-host-machine)
  * [Running the test agent on SGM platform](#running-the-test-agent-on-sgm-platform)
- [Test execution report](#test-execution-report)

Introduction
-------

This document outlines how to fetch, adapt, and build the SCMI test suite. The steps to build and run the test suite for a mocker platform on host machine and System Guidance for Mobile (SGM) [System Guidance] are provided as reference.

## Prerequisites
The following are the prerequisites to build the SCMI test suite.

### Host machine requirements and tools
-------

The software is built on Ubuntu 16.04 LTS (64-bit).
Packages used for building the software are installed from this distribution unless otherwise specified. Though it is tested only on Ubuntu 16.04, it is expected to also work on later versions of Ubuntu.

Install the following tools with the command:

>`sudo apt-get install build-essential gcc make git`

Download and install the AArch64 little-endian GCC cross compiler as specified in [Linaro Release Notes].

Downloading the SCMI test suite source code
-------

To download the SCMI test suite source code from GitHub, execute:

>`git clone https://github.com/ARM-software/scmi-tests`

Compliance suite design and library of tests
-------

For details on the SCMI compliance suite design, see [Validation Methodology Document]. The design document provides an overview of the design considerations, the interfaces that must be implemented to adapt this test suite for your own platform, and the overall code organization. Some control flows are also detailed to describe the execution flow.

For details on the tests that are included in the test suite, see [Test checklist].

Build steps
-------

The compliance suite can be built as a library which can be linked to your execution enviroment or as an Operating System Power Management (OSPM) agent running on Linux.
The tests are designed for SCMI version 2.0, but backward compatibility is maintained with version 1.0. You can choose the version while building the tests.

### 1. Building the test suite as a library

To start the build, perform the following steps from the `<test suite clone location>`.

>`CROSS_COMPILE=<path/to/your/AArch64/compiler/bin>/aarch64-linux-gnu- make clean`
>
>`CROSS_COMPILE=<path/to/your/AArch64/compiler/bin>/aarch64-linux-gnu- make PROTOCOLS=<comma separated protocol list> VERSION=<scmi version> VERBOSE=<level>`

Example:

>`CROSS_COMPILE=<path/to/your/AArch64 compiler/bin>/aarch64-linux-gnu- make clean`
>
>`CROSS_COMPILE=<path/to/your/AArch64 compiler/bin>/aarch64-linux-gnu- make PROTOCOLS=base,clock,power,system_power,performance,sensor VERSION=1 VERBOSE=1`

If you do not specify the PROTOCOLS variable when invoking the make command, Base Protocol test library alone is generated by default.
If you do not specify the VERSION variable when invoking the make command, SCMI version 1.0 tests are generated by default.

The output of this make command is the libscmi_test.a library that includes the tests for all the specified protocols and version . The library will be generated in the `<test suite clone location>`. The arguments passed to the PROTOCOLS parameter are the subfolder names that are found in `<test suite clone location>/test_pool` folder.
If there are memory constraints on the platform, fewer tests can be included by modifying the PROTOCOLS variable. The library can be linked to your execution enviroment.

### 2. Building the test suite as a test agent
A test agent is an execution wrapper for libscmi_test.a. Currently, support is provided for the following two platforms.

#### 2.1 Mocker platform

A self-test framework is implemented on a mocker platform that provides a simulated response to the SCMI commands issued by the test suite. To start the build, perform the following steps from the `<test suite clone location>`.

>`make clean`
>
>`make PLAT=mocker PROTOCOLS=base,clock,performance,power,system_power,sensor VERSION=1 VERBOSE=1`

The output will be libscmi_test.a and scmi_test_agent in the `<test suite clone location>`.
When the test library is extended to support new protocols or commands, it is **not** necessary to support the same in the mocker platform, unless it is warranted for testing the framework changes.

#### 2.2 OSPM agent for SGM

A reference implementation for SGM is provided in the suite. In addition to building the library, the build also enables the SCMI test suite to run as an OSPM agent running from Linux using publicly available mailbox test driver interface. To start the build, perform the following steps from the `<test suite clone location>`.

>`CROSS_COMPILE=<path/to/your/AArch64 compiler/bin>/aarch64-linux-gnu- make clean`
>
>`CROSS_COMPILE=<path/to/your/AArch64 compiler/bin>/aarch64-linux-gnu- make PLAT=sgm776 PROTOCOLS=base,clock,power,performance,system_power,sensor VERSION=1 VERBOSE=1`

The output will be libscmi_test.a and scmi_test_agent for the mocker platform in the `<test suite clone location>`.
**NOTE**: 
* The same executable can be used on SGM-775 or SGM-776
* You must rebuild the Linux kernel and device trees for SGM by following the [Guide to test SCMI on SGM].

Test suite execution
-------

### Running the test agent on the host machine

To run the test suite on the host machine, execute the command:

>`./scmi_test_agent`

For the self_test/mocker platform, the test logs are dumped on the console itself.

### Running the test agent on SGM platform

To run the test suite on the SGM platform, execute the following command in the filesystem that is mounted on SGM:

>`cd <path/to/executable in filesystem>`
>
>`./scmi_test_agent`

The test logs are captured in a report file arm\_scmi\_test\_log.txt in the same directory as the executable.

Test execution report
-------

The test report lists results per test case. The tests are organized as a collection within individual protocol. For every test case, the following verification steps occur:

`Message Header`: The message header that is received from the platform is checked against what was in the send command.

`Status`: The platform returns a status for a command that is issued by the agent and this is checked as per specification or as per expected values provided by you.

`Return Values - if relevant`: The remaining return values for a command response are valid based on status return value. Checks are performed only if status return value returned SUCCESS and expected values were given by the user.

Each individual check delivers a PASS, FAIL, or SKIPPED.

- - - - - - - - - - - - - - - - -

_Copyright (c) 2019, Arm Limited and Contributors. All rights reserved._

[Linaro Release Notes]:		https://community.arm.com/dev-platforms/b/documents/posts/linaro-release-notes-current
[Validation Methodology Document]:		./Arm_SCMI_Validation_Methodology.pdf "SCMI Test Suite Design"
[Test checklist]:		./scmi_testlist.md "SCMI Test Specification"
[System Guidance]:    https://developer.arm.com/ip-products/system-ip/reference-design
[Guide to test SCMI on SGM]:  ./guide_sgm_testing.md
